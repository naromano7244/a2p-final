<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A2P Compliance Guide</title>
  <!-- A2P Results v1.3 ‚Äì updated for SINGLE image -->
  <!-- Perf hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://i.ibb.co" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    :root{
      --primary:#5c27d4; --primary-2:#6e3de8; --primary-light:#f3efff;
      --text:#2d3748; --muted:#667085; --border:#e2e8f0;
      --success:#48bb78; --shadow-sm:0 2px 4px rgba(0,0,0,.05);
      --shadow-md:0 6px 22px rgba(0,0,0,.09); --r-md:12px; --r-sm:8px;
    }
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",sans-serif;margin:0;background:#f7f7fa;color:var(--text);line-height:1.6}
    .container{max-width:900px;margin:36px auto;background:#fff;border-radius:var(--r-md);box-shadow:var(--shadow-md);overflow:hidden}
    @media (max-width:940px){.container{margin:18px}}
    .header{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;text-align:center;padding:36px 20px;position:relative}
    .header::after{content:"";position:absolute;left:0;right:0;bottom:0;height:4px;background:linear-gradient(90deg,#4c21b0,#6e3de8)}
    .header h1{margin:0;font-size:28px;font-weight:700;line-height:1.35}
    .header p{margin:12px 0 0;font-size:15.5px;opacity:.95}
    .disclosure{background:#fff3cd;color:#7a5a00;border:1px solid #ffe08a;border-radius:var(--r-sm);padding:10px 16px;margin:18px 24px 0;text-align:center;font-size:14px}

    .section{padding:28px 28px;border-top:1px solid var(--border);transition:background .18s ease}
    .section:first-of-type{border-top:0}
    .section:hover{background:#fafafa}
    h2{font-size:20px;margin:0 0 16px;color:var(--primary);display:flex;align-items:center;gap:8px}

    /* Screenshots */
    .screenshot-wrapper{margin:14px 0}
    .skeleton{border:1px solid var(--border);border-radius:var(--r-sm);background:linear-gradient(90deg,#f4f6f9, #eef2f7, #f4f6f9);background-size:200% 100%;animation:shimmer 1.2s linear infinite;height:260px}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .screenshot{width:100%;height:auto;border-radius:var(--r-sm);box-shadow:var(--shadow-sm);background:#f8fafc;border:1px solid var(--border);opacity:0;transition:opacity .25s ease}
    .screenshot.loaded{opacity:1}

    /* Code + copy */
    pre{background:#f8fafc;padding:16px;border-radius:var(--r-sm);white-space:pre-wrap;word-break:break-word;font:13.5px ui-monospace,SFMono-Regular,Menlo,monospace;border:1px solid var(--border);margin:12px 0}
    code{background:#f1f5f9;padding:3px 6px;border-radius:4px;font-size:13.5px;color:var(--primary)}
    .copy-btn{background:var(--primary);color:#fff;border:0;padding:8px 14px;font-size:13.5px;border-radius:var(--r-sm);cursor:pointer;margin:8px 0;display:inline-flex;align-items:center;gap:6px;transition:transform .15s ease, box-shadow .2s ease}
    .copy-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
    .copied-msg{display:inline-flex;align-items:center;margin-left:10px;color:var(--success);font-weight:600;font-size:13.5px;opacity:0;animation:copfade 2s ease forwards}
    @keyframes copfade{0%{opacity:0;transform:translateY(4px)}10%,90%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-3px)}}

    .pdf-section{background:var(--primary-light);text-align:center;padding:32px}
    .pdf-section h3{margin:0 0 14px;color:var(--primary)}
    .pdf-button{display:inline-flex;align-items:center;gap:8px;background:var(--primary);color:#fff;padding:11px 20px;border-radius:var(--r-sm);font-weight:600;text-decoration:none;transition:transform .15s}
    .pdf-button:hover{transform:translateY(-1px)}
    ul{padding-left:20px;margin:14px 0} li{margin-bottom:10px} li::marker{color:var(--primary)}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üßô‚Äç‚ôÇÔ∏è Just like magic!<br>Your A2P Compliance Kit is Ready!</h1>
      <p>Thanks for using A2P Wizard. Below is everything you need to get your campaign approved.</p>
    </div>

    <div class="disclosure">‚ö†Ô∏è If your campaign was previously rejected, <u>recreate and resubmit</u> a new campaign for best results.</div>

    <div class="section" style="text-align:center;background:#f9f9ff;padding:22px">
      <h3 style="color:var(--primary);margin:0 0 8px">üìà Agencies: Want more time to grow revenue?</h3>
      <p style="margin:0 auto;max-width:640px">White-label A2P done-for-you ‚Äî fast approvals, clean integrations, no stress.</p>
      <a href="https://a2pwizard.com/contactus" class="pdf-button" style="margin-top:14px">Get Done-For-You Help for $50 ‚Üí</a>
    </div>

    <div class="section">
      <h2>üì∏ Screenshot Proof</h2>
      <div id="imgLoading" class="muted">Image rendering‚Ä¶</div>

      <div class="screenshot-wrapper">
        <div id="sk1" class="skeleton"></div>
        <img id="img1" class="screenshot" alt="Opt-in Proof Image" loading="lazy" decoding="async" width="1200" height="675" />
        <code id="img1url"></code>
        <button class="copy-btn" onclick="copyText('img1url', this)">Copy</button>
      </div>
    </div>

    <div class="section">
      <h2>üìÑ Copy & Paste Templates</h2>
      <p>This is what reviewers look for and is the key to getting approved.</p>
      <p><strong id="biz1">Client Business</strong> Opt-in Form / Image URL: <code id="img1link"></code></p>
      <button class="copy-btn" onclick="copyText('img1link', this)">Copy</button>
    </div>

    <div class="section">
      <h2>üìÉ Use Case Description</h2>
      <pre id="useCase">Loading use case description...</pre>
      <button class="copy-btn" onclick="copyText('useCase', this)">Copy</button>
    </div>

    <div class="section">
      <h2>üí¨ Sample Messages</h2>
      <p><strong>Sample Message One:</strong></p>
      <pre id="msg1">Loading...</pre>
      <button class="copy-btn" onclick="copyText('msg1', this)">Copy</button>

      <p style="margin-top:14px"><strong>Sample Message Two:</strong></p>
      <pre id="msg2">Loading...</pre>
      <button class="copy-btn" onclick="copyText('msg2', this)">Copy</button>
    </div>

    <div class="section">
      <h2>‚úÖ How do Contacts Opt-in to Messages?</h2>
      <pre id="consentCopy">Loading...</pre>
      <button class="copy-btn" onclick="copyText('consentCopy', this)">Copy</button>
    </div>

    <div class="section">
      <h2>üìú Opt-In Message</h2>
      <pre id="optInMessage">Loading...</pre>
      <button class="copy-btn" onclick="copyText('optInMessage', this)">Copy</button>
    </div>

    <div class="section">
      <h2>‚úÖ Final Step: HighLevel Opt-In Method</h2>

      <p>
        HighLevel now requires an <strong>Opt-In Method</strong> and a
        <strong>public Opt-in Form / Image URL</strong>.
      </p>

      <ul>
        <li><strong>Opt-In Method:</strong> Website form</li>
        <li>
          <strong>Opt-in Form / Image URL:</strong><br>
          Paste the link below into the HighLevel field exactly as shown.
        </li>
      </ul>

      <pre id="optInFormUrl">Loading...</pre>
      <button class="copy-btn" onclick="copyText('optInFormUrl', this)">
        Copy Opt-In URL
      </button>

      <p style="margin-top:12px;font-size:14px;color:var(--muted)">
        ‚úÖ This link must be publicly accessible and show clear consent language.
      </p>
    </div>

    <div class="section">
      <h2>üí° Tips for Approval</h2>
      <ul>
        <li>Submit between 8am‚Äì11am on weekdays</li>
        <li>Use a fresh number/campaign if resubmitting</li>
        <li>Brand approval usually takes ~24 hours</li>
        <li><strong>Follow all best practices</strong> to avoid delays</li>
      </ul>
      <img src="https://i.ibb.co/S4JzfBYz/image-4.png" class="screenshot loaded" alt="Tips Screenshot" loading="lazy" decoding="async" width="1200" height="675">
    </div>

    <div class="pdf-section">
      <h3>Need to send this to a client? Here‚Äôs a white-labeled guide!</h3>
      <a href="#" onclick="window.print()" class="pdf-button">Download PDF</a>
    </div>

    <div class="section" style="text-align:center;background:#f9f9ff;padding:22px">
      <h3 style="color:var(--primary);margin:0 0 8px">üìà Agencies: Want more time to grow revenue?</h3>
      <p style="margin:0 auto;max-width:640px">White-label A2P done-for-you ‚Äî fast approvals, clean integrations, no stress.</p>
      <a href="https://a2pwizard.com/contactus" class="pdf-button" style="margin-top:14px">Get Done-For-You Help for only $50 ‚Üí</a>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    function cacheKey(q){ return "a2p_results_" + String(q || "").toLowerCase().trim(); }

    const API_BASE = "https://script.google.com/macros/s/AKfycbxc0m07Q1u1c3JyyKAKTdYvmrkj6C9UxdI-wjIZM7b0uidEreM-G31Ub3LQCObmhiIs/exec";
    const SITE_DOMAIN = "smsdatareg.com";

    async function fetchJSON(url, timeoutMs=12000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r = await fetch(url, {signal: ctrl.signal, cache: "no-store"});
        if(!r.ok) throw new Error("HTTP "+r.status);
        return await r.json();
      } finally { clearTimeout(t); }
    }

    function pipeImage(imgEl, skeletonEl, src){
      if(!imgEl) return;
      imgEl.onload = ()=>{ imgEl.classList.add("loaded"); if(skeletonEl) skeletonEl.style.display="none"; const l=$("imgLoading"); if(l) l.style.display="none"; };
      imgEl.onerror = ()=>{ if(skeletonEl) skeletonEl.style.display="none"; const l=$("imgLoading"); if(l) l.style.display="none"; };
      imgEl.src = src;
    }

    function updateText(id, text){ const el=$(id); if (el) el.textContent = text; }

    function showTopError(message){
      const container = document.querySelector(".container");
      if(!container) return;
      let warn = document.getElementById("a2pTopWarn");
      if(!warn){
        warn = document.createElement("div");
        warn.id = "a2pTopWarn";
        warn.style.cssText = "margin:12px 28px 0;color:#b42318;background:#fff5f5;border:1px solid #fecaca;border-radius:10px;padding:10px 14px;font-size:14px;";
        container.prepend(warn);
      }
      warn.textContent = message;
    }

    // Slug must be safe for subdomain use
    // Allowed: a-z, 0-9, hyphen
    // If anything else exists, we show the exact error requested.
    function buildWebsiteFromSlug(slugRaw){
      const slug = String(slugRaw || "").trim();

      if(!slug){
        return { ok:false, error: "Error! could not generate the website (missing slug)." };
      }

      const lower = slug.toLowerCase();
      const allowed = /^[a-z0-9-]+$/;

      if(!allowed.test(lower)){
        return {
          ok:false,
          error: "Error! could not generate the website, make sure to avoid using special characters ( & , ' space / ? # % + . )"
        };
      }

      return { ok:true, website: `https://${lower}.${SITE_DOMAIN}` };
    }

    function hydrate(data){
      // Handle API-level errors without breaking the page
      if(data && data.ok === false){
        showTopError(data.error || "Error loading your results. Please try again.");
      }

      // Map sheet headers (exact names) -> variables used by the page
      const businessName   = String((data && data["Legal Business name"]) || "").trim();
      const proofImg       = String((data && data["img1"]) || "").trim();
      const slug           = String((data && data["Slug"]) || "").trim();

      // Fallbacks so nothing shows as "undefined"
      const bn = businessName || "Client Business";
      updateText("biz1", bn);

      // Build website from slug (SOURCE OF TRUTH)
      const websiteRes = buildWebsiteFromSlug(slug);
      const website = websiteRes.ok ? websiteRes.website : "";

      if(!websiteRes.ok){
        showTopError(websiteRes.error);
      }

      // IMPORTANT: "Opt-in Form / Image URL" must be the WEBSITE (not the image)
      updateText("img1link", website || "ERROR: Website could not be generated");

      // Final Step field must be WEBSITE
      updateText("optInFormUrl", website || "ERROR: Website could not be generated");

      // Screenshot block (IMG1)
      updateText("img1url", proofImg);

      // Approved templates (dynamic)
      updateText("useCase",
`This campaign sends appointment information ‚Äì confirmation & reminder messages to customers once they have booked an appointment with ${bn} on ${website || "[WEBSITE ERROR]"} and opted-in to receive promotional and notification SMS from ${bn}`
      );

      updateText("msg1",
`Hi John! This is Jane from ${bn}.. Our appointment for March 20th at 11:00 AM is confirmed. Please reach out in case you need to reschedule. Reply STOP to unsubscribe.`
      );

      updateText("msg2",
`Hello, this is Jason with ${bn}.. We are confirming your appointment tomorrow at 9 AM. Reply STOP to cancel.`
      );

      updateText("consentCopy",
`End users opt-in by visiting ${website || "[WEBSITE ERROR]"} and filling in their details. Users check a box to receive notifications & promotional messages to provide their consent`
      );

      updateText("optInMessage",
`You have successfully opted-in to receive notification and promotional SMS from ${bn}. Please reply STOP if you need to Opt-out in the future.`
      );

      // Render image
      if (proofImg) pipeImage($("img1"), $("sk1"), proofImg);
      else {
        const sk = $("sk1"); if(sk) sk.style.display="none";
        const l = $("imgLoading"); if(l) l.style.display="none";
      }
    }

    async function init(){
      const params = new URLSearchParams(location.search);
      const slug = params.get("slug");
      const id = params.get("id");

      const queryVal = (slug || id || "").trim();
      if(!queryVal){
        showTopError("Missing id or slug. Add ?slug=businessslug or ?id=uid-... to the URL.");
        const l = $("imgLoading"); if(l) l.style.display="none";
        const sk = $("sk1"); if(sk) sk.style.display="none";
        return;
      }

      const key = cacheKey(queryVal);

      // Build API url: prefer explicit slug
      const apiUrl = slug
        ? (API_BASE + "?slug=" + encodeURIComponent(slug))
        : (API_BASE + "?id=" + encodeURIComponent(id));

      try{
        const cached = localStorage.getItem(key);
        if(cached){
          hydrate(JSON.parse(cached));
          fetchJSON(apiUrl)
            .then(d=>{ localStorage.setItem(key, JSON.stringify(d)); hydrate(d); })
            .catch(()=>{});
          return;
        }
      }catch(e){}

      try{
        const data = await fetchJSON(apiUrl, 12000);
        localStorage.setItem(key, JSON.stringify(data));
        hydrate(data);
      }catch(err){
        console.error("Error fetching data", err);
        showTopError("We‚Äôre having trouble loading live data. Try refreshing, or check back in a minute.");
        setTimeout(()=>{ const l=$("imgLoading"); if(l) l.style.display="none"; }, 3000);
      }
    }

    function copyText(elId, btn){
      const el=$(elId);
      const txt=(el?.textContent||"").trim();
      if(!txt) return;
      navigator.clipboard.writeText(txt).then(()=>{
        const msg=document.createElement("span");
        msg.className="copied-msg";
        msg.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg> Copied!`;
        btn.insertAdjacentElement("afterend", msg);
        setTimeout(()=>msg.remove(), 2000);
      });
    }

    init();
  </script>
</body>
</html>
